<apex:page showHeader="false" title="Analytics API - Waterfall" standardStylesheets="false">

	<apex:includeScript value="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js" />

	<apex:includeScript value="{!URLFOR($Resource.AnalyticsAPI, 'highcharts.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.AnalyticsAPI, 'highcharts-more.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.AnalyticsAPI, 'exporting.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.AnalyticsAPI, 'ForceTK.js')}"  />
	<script>
		$(document).ready(function() {

		    var reportId = '{!$CurrentPage.parameters.reportId}';
		    
		    if (reportId) {
	            // Get an instance of the REST API client and set the session ID
	            var client = new forcetk.Client();
	            client.setSessionToken('{!$Api.Session_ID}');
	            
	            // We'll keep the report data around for the life of the page
	            var report = null;
	    
	            // Run the report synchronously
	            client.ajax("/v29.0/analytics/reports/"+reportId+"?includeDetails=true", function(response){
	                // Save the report data
	                report = response;
	                console.log(report);
	                
	                // We're done with the status
	                $("#statusText").hide();
	                
	               	renderHighChart(report);
	                
	            }, function(jqXHR, textStatus, errorThrown){
	                // uh-oh
	                $("#statusText").text("Error: "+jqXHR.status+" "+jqXHR.statusText);
	            });
	            
	        } else {
	            $("#statusText").text("Need a reportId!");
	        }

		});
		
		function renderHighChart(report){
		
			$('#container').highcharts({
		        chart: {
		            type: 'waterfall'
		        },
		
		        title: {
		            text: report.reportMetadata.name
		        },
		
		        xAxis: {
		            type: 'category'
		        },
		
		        yAxis: {
		            title: {
		                text: 'GBP'
		            }
		        },
		
		        legend: {
		            enabled: false
		        },
		
		        tooltip: {
		            pointFormat: '<b>${point.y:,.2f}</b> GBP'
		        },
		
		        series: [{
		            upColor: Highcharts.getOptions().colors[2],
		            color: Highcharts.getOptions().colors[3],
		            data: getDataArray(report),
		            dataLabels: {
		                enabled: true,
		                formatter: function () {
		                    return Highcharts.numberFormat(this.y / 1000, 0, ',') + 'k';
		                },
		                style: {
		                    color: '#FFFFFF',
		                    fontWeight: 'bold',
		                    textShadow: '0px 0px 3px black'
		                }
		            },
		            pointPadding: 0
		        }]
		    });
		
		}
		
		function getDataArray(report){
			var dataArray = [];
			$.each(report.groupingsDown.groupings, function(index, grouping) {
                dataArray.push({"name":grouping.label, "y": report.factMap[index.toString()+"!T"].aggregates[0].value});
            });
           	return dataArray;
		}
	</script>
	
	<h1 id="statusText">Loading data...</h1>
	
	<div id="container" style="min-width: 310px; max-width: 600px; height: 400px; margin: 50px auto"></div>
	
</apex:page>